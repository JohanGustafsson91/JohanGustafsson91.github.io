name: CI Pipeline

# Trigger on pull requests to main branch and manual dispatch
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  # Allow manual trigger for debugging
  workflow_dispatch:

# Set permissions for the workflow
permissions:
  pull-requests: write
  contents: write
  checks: write

jobs:
  # Call the reusable validate workflow (lint, test, build)
  validate:
    name: Validate PR
    uses: JohanGustafsson91/github-reusable-actions/.github/workflows/validate.yml@main
    with:
      node-version: "20"
      package-manager: "pnpm"
      lint-script: "lint"
      test-script: "test run"
      build-script: "build"

  # Enable auto-merge for Dependabot PRs after validation
  auto-merge:
    name: Enable auto-merge for Dependabot PRs
    needs: [validate]
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Enable auto-merge for Dependabot PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
